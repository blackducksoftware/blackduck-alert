package com.synopsys.integration.alert.provider.blackduck.collector;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;

import java.io.File;
import java.nio.charset.Charset;
import java.time.Instant;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.stream.Collectors;

import org.apache.commons.io.FileUtils;
import org.junit.Test;
import org.springframework.core.io.ClassPathResource;

import com.google.gson.Gson;
import com.synopsys.integration.alert.common.enumeration.FormatType;
import com.synopsys.integration.alert.common.model.AggregateMessageContent;
import com.synopsys.integration.alert.common.model.CategoryItem;
import com.synopsys.integration.alert.common.workflow.processor.DefaultMessageContentProcessor;
import com.synopsys.integration.alert.common.workflow.processor.DigestMessageContentProcessor;
import com.synopsys.integration.alert.common.workflow.processor.MessageContentProcessor;
import com.synopsys.integration.alert.database.entity.NotificationContent;
import com.synopsys.integration.alert.provider.blackduck.BlackDuckProvider;
import com.synopsys.integration.alert.workflow.filter.field.JsonExtractor;
import com.synopsys.integration.blackduck.api.generated.enumeration.NotificationType;

public class BlackDuckVulnerabilityMessageContentCollectorTest {
    private final Gson gson = new Gson();
    private final List<MessageContentProcessor> messageContentProcessorList = Arrays.asList(new DefaultMessageContentProcessor(), new DigestMessageContentProcessor());

    @Test
    public void testCollectingVulnerability() throws Exception {
        final JsonExtractor jsonExtractor = new JsonExtractor(gson);
        final BlackDuckVulnerabilityMessageContentCollector collector = new BlackDuckVulnerabilityMessageContentCollector(jsonExtractor, messageContentProcessorList);
        final ClassPathResource classPathResource = new ClassPathResource("json/vulnerabilityTest.json");
        final File jsonFile = classPathResource.getFile();
        final String notificationContent = FileUtils.readFileToString(jsonFile, Charset.defaultCharset());
        final Date creationDate = Date.from(Instant.now());
        final NotificationContent notification = new NotificationContent(creationDate, BlackDuckProvider.COMPONENT_NAME, creationDate, NotificationType.VULNERABILITY.name(), notificationContent);

        collector.insert(notification);
        final List<AggregateMessageContent> aggregateMessageContentList = collector.collect(FormatType.DEFAULT);

        final int topicCount = 3;
        final int categoryPerTopic = 15;
        assertFalse(aggregateMessageContentList.isEmpty());
        assertEquals(topicCount, aggregateMessageContentList.size());
        final List<CategoryItem> categoryItemList = aggregateMessageContentList.stream().map(AggregateMessageContent::getCategoryItemList).flatMap(List::stream).collect(Collectors.toList());
        assertEquals(topicCount * categoryPerTopic, categoryItemList.size());
    }

    @Test
    public void testCollectingVulnerabilityDigest() throws Exception {
        final JsonExtractor jsonExtractor = new JsonExtractor(gson);
        final BlackDuckVulnerabilityMessageContentCollector collector = new BlackDuckVulnerabilityMessageContentCollector(jsonExtractor, messageContentProcessorList);
        final ClassPathResource classPathResource = new ClassPathResource("json/vulnerabilityTest.json");
        final File jsonFile = classPathResource.getFile();
        final String notificationContent = FileUtils.readFileToString(jsonFile, Charset.defaultCharset());
        final Date creationDate = Date.from(Instant.now());
        final NotificationContent notification = new NotificationContent(creationDate, BlackDuckProvider.COMPONENT_NAME, creationDate, NotificationType.VULNERABILITY.name(), notificationContent);

        collector.insert(notification);
        final List<AggregateMessageContent> aggregateMessageContentList = collector.collect(FormatType.DIGEST);
        final int topicCount = 3;
        final int categoryPerTopic = 11;
        assertFalse(aggregateMessageContentList.isEmpty());
        assertEquals(topicCount, aggregateMessageContentList.size());
        final List<CategoryItem> categoryItemList = aggregateMessageContentList.stream().map(AggregateMessageContent::getCategoryItemList).flatMap(List::stream).collect(Collectors.toList());
        assertEquals(topicCount * categoryPerTopic, categoryItemList.size());
    }
}
